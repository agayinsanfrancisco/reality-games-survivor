# Debugging Protocol (MANDATORY)

Before suggesting ANY fix, change, or improvement, complete these steps in order.

## Step 0: Verify Deployment Reality

Run these checks FIRST. Do not skip.

1. Confirm the commit on origin/main: `git log origin/main -1 --oneline`
2. Confirm local HEAD matches: `git log HEAD -1 --oneline`
3. Verify you're on main: `git branch --show-current` (must be `main`)
4. Check for uncommitted changes: `git status`
5. Verify deployed build matches the code you're reading

If ANY of these are misaligned, stop and fix the git state before touching code.

## Worktrees: BANNED

Never use `git worktree` commands. Ever.

- Do not create worktrees
- Do not suggest worktrees as a solution
- Do not check for existing worktrees
- If worktrees exist, flag them as tech debt to eliminate

One repo, one branch checked out, one source of truth.

## Step 1: Name the Root Cause

Before surface-level suggestions, explicitly state:

"The root cause is: [X]"

This must be structural, not symptomatic. Ask:
- What wrong assumption is baked into the foundation?
- What constraint am I accepting that I shouldn't?
- What's the user not seeing because they're too close?

## Step 2: Only Then Suggest Changes

After completing Steps 0 and 1, you may recommend fixes.

## Violations

Jumping to surface-level fixes without verifying deploy state and naming root cause = failed task. Start over.

---

# RGFL Admin System - AI-Readable System Blueprint

## 1. PURPOSE & SCOPE

### Mission

Administrative control center for Reality Games Fantasy League enabling platform operators to monitor system health, manage game state, communicate with users, and track business metrics across all fantasy leagues.

### Primary Users and Jobs-to-be-Done

Platform Administrator (Blake) needs to:
- Monitor system health and fix failures before users notice
- Manage game state including castaways, episodes, and scoring
- Communicate with users via email, push, SMS, and announcements
- Track business metrics including user engagement, retention, and donations
- Manage leagues and users including support issues and account problems

### Explicitly Out of Scope

- Public-facing user features (handled by main app)
- Scoring logic and rules engine (separate Scoring page, already built)
- Season creation and configuration (separate Seasons page under Manage)
- Direct database manipulation (all actions via admin UI or API)
- Financial reconciliation with Stripe (manual process for now)
- Multi-tenant admin (single admin user assumed)

---

## 2. ARCHITECTURE

### Components

| Component | Role | Tech Stack | Owner |
|-----------|------|------------|-------|
| Admin Frontend | Admin user interface and dashboards | React 18, TypeScript, Vite, TanStack Query, Tailwind CSS, Lucide React, React Router | Blake |
| Admin API | Business logic, authorization, admin operations | Node.js, Express, TypeScript, Zod validation | Blake |
| Database | State persistence, audit logging, analytics | Supabase PostgreSQL with Row Level Security | Blake |
| Authentication | Admin session management | Supabase Auth (email/password, magic links) | Blake |
| Background Jobs | Scheduled tasks, email processing, pick locking | node-cron on Express server | Blake |
| File Storage | Avatar uploads, exports, attachments | Supabase Storage | Blake |
| Realtime | Live updates for chat and notifications | Supabase Realtime subscriptions | Blake |
| Error Tracking | Exception monitoring and alerting | Sentry | Blake |

### Tech Stack Summary

Frontend: React 18, TypeScript, Vite, React Router, TanStack Query, Tailwind CSS, Lucide React
Backend: Node.js, Express, TypeScript, node-cron, Zod
Database: Supabase PostgreSQL with RLS policies
Auth: Supabase Auth with email/password and magic links
Payments: Stripe with webhooks
Email: Resend for transactional emails
SMS: Twilio (planned, not yet implemented)
Hosting: Railway for backend, Vercel or Railway for frontend
Version Control: GitHub
Monitoring: Sentry for error tracking

### Key Dependencies

| Package | Purpose | Version |
|---------|---------|---------|
| @supabase/supabase-js | Database client, auth, storage, realtime | Latest |
| @tanstack/react-query | Server state management, caching, mutations | v5 |
| stripe | Payment processing, Connect accounts, webhooks | Latest |
| resend | Transactional email delivery | Latest |
| node-cron | Scheduled job execution | Latest |
| zod | Runtime schema validation for API inputs | Latest |
| react-router-dom | Client-side routing | v6 |
| lucide-react | Icon library | Latest |

### External Services

| Service | Purpose | Integration Type | Failure Impact |
|---------|---------|------------------|----------------|
| Stripe | Payment processing, donation tracking, Connect accounts | REST API via stripe package, Webhooks | Cannot process donations, revenue tracking fails |
| Twilio | SMS notifications, A2P messaging (planned) | REST API | SMS channel unavailable, fallback to email |
| Resend | Transactional email delivery | REST API via resend package, Webhooks | Email channel unavailable, critical for pick reminders |
| Supabase | Database, auth, storage, realtime | @supabase/supabase-js SDK | Complete system failure |
| Railway | API hosting, environment management | Deployment platform | API unavailable |
| Sentry | Error tracking, performance monitoring | SDK integration | No error visibility, debugging harder |

---

## 3. DATA FLOW

### Core Entities

User represents a platform account with authentication credentials and profile data. User hasMany LeagueMemberships, hasMany Picks, hasMany Donations, hasMany NotificationPreferences. Managed by Supabase Auth with extended profile in users table.

League represents a fantasy competition group. League hasMany LeagueMemberships, hasMany Donations, belongsTo Commissioner (User), hasOne StripeConnectAccount (optional).

LeagueMembership represents a user's participation in a league. LeagueMembership belongsTo User, belongsTo League, hasMany Picks, hasMany Rosters.

Episode represents a single Survivor episode. Episode belongsTo Season, hasMany Picks, hasMany ScoringEvents.

Castaway represents a Survivor contestant. Castaway belongsTo Season, belongsTo Tribe, hasMany ScoringEvents, hasMany RosterSlots.

Pick represents a user's predictions for an episode. Pick belongsTo User, belongsTo Episode, belongsTo League, hasMany PickSelections.

Donation represents a monetary contribution to a league. Donation belongsTo User, belongsTo League, belongsTo Season, tracked via Stripe PaymentIntent.

Announcement represents a platform-wide or targeted message. Announcement hasMany AnnouncementDismissals, optionally belongsTo League.

Email represents a transactional email record. Email belongsTo User, hasMany EmailEvents tracked via Resend webhooks.

JobRun represents an execution of a scheduled task via node-cron.

### Critical Paths

#### Path 1: Admin Views Dashboard

Admin loads /admin route. React Router renders DashboardPage component. TanStack Query fires useQuery for dashboard data. Express API handles GET /api/admin/dashboard. API executes parallel Supabase queries for alerts, timeline, vitals, activity. Response cached by TanStack Query with 30 second stale time. React components render AlertBanner, WeeklyTimeline, VitalsGrid, ActivityFeed.

#### Path 2: Admin Sends Pick Reminder

Admin clicks Send Reminder button in AlertBanner. React fires useMutation for reminder endpoint. Express API handles POST /api/admin/notifications/pick-reminder. API queries Supabase for users without picks for episode. API queries notification_preferences for each user. API calls Resend API to queue emails for email-enabled users. API logs notification batch to notification_logs table via Supabase. TanStack Query invalidates dashboard query to refresh alert state. React shows success toast via notification system.

#### Path 3: Admin Eliminates Castaway

Admin navigates to /admin/manage/castaways/:id. React renders CastawayDetailPage with data from useQuery. Admin clicks Eliminate button, React shows confirmation modal. Modal shows impact preview from useQuery for affected teams count. Admin confirms with episode_id and elimination method. React fires useMutation for POST /api/admin/castaways/:id/eliminate. Express validates request body with Zod schema. API updates castaway record in Supabase. API triggers roster recalculation via Supabase function. API queues notifications via Resend for affected owners. API logs to audit_log table. TanStack Query invalidates castaways and rosters queries. React updates UI and shows success toast.

#### Path 4: Admin Retries Failed Emails

Admin navigates to /admin/communicate/email. React renders EmailQueuePage with useQuery for failed emails. Admin clicks Retry All button. React fires useMutation for POST /api/admin/emails/retry. Express API updates email status to pending in Supabase. API calls Resend API to re-queue each email. Resend processes emails and fires webhooks on completion. Express webhook handler at POST /api/webhooks/resend receives events. Handler updates email status and creates email_event record. TanStack Query refetches on interval to show updated status.

#### Path 5: Stripe Webhook Processing

Stripe fires webhook to POST /api/webhooks/stripe. Express validates webhook signature using stripe.webhooks.constructEvent. Handler switches on event.type. For charge.succeeded: update donations table status to completed, queue thank you email via Resend. For application_fee.created: log to platform_revenue table for analytics. For transfer.created: log to league_payouts table. For account.updated: update league stripe_account_status. Response returns 200 to acknowledge receipt.

---

## 4. INTEGRATION POINTS

### Inbound (Things That Call This System)

| Source | Trigger | Handler | Expected Behavior |
|--------|---------|---------|-------------------|
| Admin Browser | Route navigation, user actions | React Router, TanStack Query | Render admin UI, execute API calls |
| Stripe Webhooks | Payment events | POST /api/webhooks/stripe | Update donation status, log revenue |
| Resend Webhooks | Email delivery events | POST /api/webhooks/resend | Update email status, track metrics |
| node-cron | Scheduled intervals | Cron job functions | Execute background tasks |

### Outbound (Things This System Calls)

| Destination | When | Package/Method | What Data |
|-------------|------|----------------|-----------|
| Supabase Database | Every admin operation | @supabase/supabase-js | CRUD operations on all tables |
| Supabase Auth | Login, session validation | @supabase/supabase-js | Credentials, JWT tokens |
| Supabase Storage | File operations | @supabase/supabase-js | File blobs, signed URLs |
| Stripe API | Payment operations | stripe package | Payment intents, Connect accounts |
| Resend API | Email operations | resend package | Email content, recipient, metadata |
| Twilio API | SMS operations (planned) | twilio package | Message body, recipient phone |
| Sentry | Error reporting | @sentry/node, @sentry/react | Exceptions, breadcrumbs, context |

### Webhooks and Events

#### Stripe Webhooks (POST /api/webhooks/stripe)

charge.succeeded: Payment completed. Payload contains amount, metadata with league_id, user_id, season_id. Handler updates donations.status to completed.

application_fee.created: Platform 7% fee collected. Payload contains amount, charge_id. Handler inserts to platform_revenue table.

transfer.created: Funds sent to league Connect account. Payload contains amount, destination. Handler inserts to league_payouts table.

account.updated: Connect account status changed. Payload contains account_id, charges_enabled, payouts_enabled. Handler updates leagues.stripe_account_status.

#### Resend Webhooks (POST /api/webhooks/resend)

email.delivered: Email reached recipient. Handler creates email_event with type delivered, updates email.status.

email.opened: Tracking pixel loaded. Handler creates email_event with type opened.

email.bounced: Delivery failed permanently. Handler updates email.status to failed, creates email_event, flags user.email_valid to false.

email.complained: Marked as spam. Handler creates email_event, flags user for review.

#### node-cron Scheduled Jobs

Email Queue Processor runs every 5 minutes. Queries pending emails, sends via Resend, updates status.

Pick Reminders runs daily at 12:00 PM PST. Queries users without picks, sends reminder emails.

Lock Picks runs Wednesday at 3:00 PM PST. Updates episode.picks_locked to true, prevents new picks.

Auto-Pick Missing runs Wednesday at 3:05 PM PST. Generates auto-picks for users who missed deadline.

Weekly Summary runs Sunday at 10:00 AM PST. Generates and sends weekly recap emails.

---

## 5. CURRENT STATE

### What's Working

| Feature/Component | Status | Tech | Last Verified |
|-------------------|--------|------|---------------|
| User authentication | Working | Supabase Auth | Dec 30, 2024 |
| Admin role checking | Working | Supabase RLS + API middleware | Dec 30, 2024 |
| Basic admin dashboard | Working, needs overhaul | React, TanStack Query | Dec 30, 2024 |
| League list and management | Working | React, Express, Supabase | Dec 30, 2024 |
| Castaway management | Working | React, Express, Supabase | Dec 30, 2024 |
| User list and management | Working | React, Express, Supabase | Dec 30, 2024 |
| Episode scoring | Working | React, Express, Supabase | Dec 30, 2024 |
| Email sending | Working | Resend | Dec 30, 2024 |
| Payment processing | Working | Stripe | Dec 30, 2024 |
| Scheduled jobs | Working | node-cron | Dec 30, 2024 |
| Error tracking | Configured | Sentry | Dec 30, 2024 |
| Realtime chat | Working | Supabase Realtime | Dec 30, 2024 |

### Known Issues

| Issue | Impact | Workaround |
|-------|--------|------------|
| 42 failed emails in queue | Users not receiving notifications | Manual retry via API |
| Email delivery rate at 60% | Degraded communication | Investigating bounce reasons |
| No email open tracking | Cannot measure effectiveness | Need Resend webhook setup |
| Dashboard shows vanity metrics | Admin time wasted | Mental filtering |
| Test accounts pollute feed | Hard to see real activity | No filter implemented |
| No alert system | Must manually check for issues | Periodic manual review |
| No audit logging | Cannot track changes | None |
| No user impersonation | Hard to debug issues | Ask for screenshots |
| TanStack Query cache not optimized | Some stale data issues | Manual refetch |

### In Progress

| Feature | Expected Completion | Blocked By |
|---------|---------------------|------------|
| Dashboard overhaul | TBD | This specification |
| Analytics restructure | TBD | This specification |
| Resend webhook integration | TBD | Webhook endpoint setup |
| Twilio SMS integration | TBD | A2P 10DLC approval |
| Stripe Connect per league | TBD | Onboarding flow design |

---

## 6. NAVIGATION ARCHITECTURE

### Route Structure

/admin - Dashboard
/admin/leagues - Leagues list
/admin/leagues/:id - League detail
/admin/scoring - Episode scoring
/admin/scoring/:episodeId - Score specific episode
/admin/manage/castaways - Castaways list
/admin/manage/castaways/:id - Castaway detail
/admin/manage/users - Users list
/admin/manage/users/:id - User detail
/admin/manage/seasons - Seasons list
/admin/communicate/announcements - Announcements
/admin/communicate/push - Push notifications
/admin/communicate/email - Email queue
/admin/communicate/sms - SMS management
/admin/system/jobs - Job monitor
/admin/system/health - System health
/admin/system/analytics - Analytics

### React Router Configuration

```typescript
import { createBrowserRouter } from 'react-router-dom';

const adminRouter = createBrowserRouter([
  {
    path: '/admin',
    element: <AdminLayout />,
    children: [
      { index: true, element: <DashboardPage /> },
      { path: 'leagues', element: <LeaguesPage /> },
      { path: 'leagues/:id', element: <LeagueDetailPage /> },
      { path: 'scoring', element: <ScoringPage /> },
      { path: 'scoring/:episodeId', element: <ScoreEpisodePage /> },
      {
        path: 'manage',
        children: [
          { path: 'castaways', element: <CastawaysPage /> },
          { path: 'castaways/:id', element: <CastawayDetailPage /> },
          { path: 'users', element: <UsersPage /> },
          { path: 'users/:id', element: <UserDetailPage /> },
          { path: 'seasons', element: <SeasonsPage /> },
        ],
      },
      {
        path: 'communicate',
        children: [
          { path: 'announcements', element: <AnnouncementsPage /> },
          { path: 'push', element: <PushNotificationsPage /> },
          { path: 'email', element: <EmailQueuePage /> },
          { path: 'sms', element: <SmsPage /> },
        ],
      },
      {
        path: 'system',
        children: [
          { path: 'jobs', element: <JobMonitorPage /> },
          { path: 'health', element: <SystemHealthPage /> },
          { path: 'analytics', element: <AnalyticsPage /> },
        ],
      },
    ],
  },
]);
```

### Navigation Component

```typescript
interface NavItem {
  path?: string;
  label: string;
  icon: LucideIcon;
  badgeKey?: string;
  children?: NavItem[];
}

const adminNavigation: NavItem[] = [
  { path: '/admin', label: 'Dashboard', icon: LayoutDashboard },
  { path: '/admin/leagues', label: 'Leagues', icon: Trophy },
  { path: '/admin/scoring', label: 'Scoring', icon: Calculator },
  {
    label: 'Manage',
    icon: Settings,
    children: [
      { path: '/admin/manage/castaways', label: 'Castaways', icon: Users },
      { path: '/admin/manage/users', label: 'Users', icon: User },
      { path: '/admin/manage/seasons', label: 'Seasons', icon: Calendar },
    ],
  },
  {
    label: 'Communicate',
    icon: MessageSquare,
    children: [
      { path: '/admin/communicate/announcements', label: 'Announcements', icon: Megaphone },
      { path: '/admin/communicate/push', label: 'Push Notifications', icon: Bell },
      { path: '/admin/communicate/email', label: 'Email Queue', icon: Mail, badgeKey: 'failedEmails' },
      { path: '/admin/communicate/sms', label: 'SMS', icon: MessageCircle },
    ],
  },
  {
    label: 'System',
    icon: Server,
    children: [
      { path: '/admin/system/jobs', label: 'Job Monitor', icon: Clock, badgeKey: 'failedJobs' },
      { path: '/admin/system/health', label: 'System Health', icon: Activity },
      { path: '/admin/system/analytics', label: 'Analytics', icon: BarChart },
    ],
  },
];
```

### Badge Count Hook

```typescript
import { useQuery } from '@tanstack/react-query';

export function useNavBadges() {
  return useQuery({
    queryKey: ['admin', 'nav-badges'],
    queryFn: async () => {
      const response = await fetch('/api/admin/badges');
      return response.json();
    },
    refetchInterval: 30000, // Refresh every 30 seconds
  });
}

// API Response Type
interface NavBadges {
  failedEmails: number;
  failedJobs: number;
  pendingDonations: number;
}
```

### Badge Count API Endpoint

```typescript
// GET /api/admin/badges
app.get('/api/admin/badges', requireAdmin, async (req, res) => {
  const { data, error } = await supabase.rpc('get_admin_badges');
  
  if (error) {
    Sentry.captureException(error);
    return res.status(500).json({ error: 'Failed to fetch badges' });
  }
  
  res.json(data);
});
```

### Badge Count Supabase Function

```sql
CREATE OR REPLACE FUNCTION get_admin_badges()
RETURNS json AS $$
  SELECT json_build_object(
    'failedEmails', (SELECT COUNT(*) FROM emails WHERE status = 'failed'),
    'failedJobs', (SELECT COUNT(*) FROM job_runs WHERE status = 'failed' AND started_at > NOW() - INTERVAL '24 hours'),
    'pendingDonations', (SELECT COUNT(*) FROM donations WHERE status = 'pending')
  );
$$ LANGUAGE sql SECURITY DEFINER;
```

---

## 7. DASHBOARD SPECIFICATION

### Purpose

Real-time operational status displaying actionable alerts, upcoming events, key metrics, and recent activity. Answers: What needs my attention right now?

### Component Hierarchy

```
DashboardPage
├── AlertBanner
│   ├── AlertItem[] (critical: red, warning: yellow)
│   └── AlertActionButton
├── WeeklyTimeline
│   ├── TimelineEvent[]
│   │   ├── EventTime
│   │   ├── EventTitle
│   │   ├── EventStatus
│   │   └── EventActionButton
│   └── EmptyState
├── VitalsGrid
│   ├── MetricCard (Active Users)
│   ├── MetricCard (Picks Submitted)
│   ├── MetricCard (Leagues Active)
│   └── MetricCard (System Health)
├── ActivityFeed
│   ├── TestAccountToggle
│   ├── ActivityItem[]
│   └── LoadMoreButton
└── RefreshIndicator
```

### TanStack Query Setup

```typescript
// hooks/useDashboard.ts
import { useQuery } from '@tanstack/react-query';

export function useDashboard() {
  return useQuery({
    queryKey: ['admin', 'dashboard'],
    queryFn: async (): Promise<DashboardData> => {
      const response = await fetch('/api/admin/dashboard');
      if (!response.ok) throw new Error('Failed to fetch dashboard');
      return response.json();
    },
    staleTime: 30 * 1000, // 30 seconds
    refetchInterval: 60 * 1000, // 1 minute
  });
}

interface DashboardData {
  alerts: SystemAlert[];
  timeline: TimelineEvent[];
  vitals: VitalsData;
  activity: ActivityItem[];
  lastUpdated: string;
}
```

### Alert Types

```typescript
type AlertSeverity = 'critical' | 'warning' | 'info';
type AlertActionType = 'link' | 'mutation';

interface SystemAlert {
  id: string;
  severity: AlertSeverity;
  title: string;
  message: string;
  actionLabel: string;
  actionType: AlertActionType;
  actionEndpoint: string;
  metadata?: Record<string, unknown>;
}
```

### Alert Generation (Express API)

```typescript
// routes/admin/dashboard.ts
import { Router } from 'express';
import { supabase } from '../lib/supabase';

const router = Router();

router.get('/dashboard', requireAdmin, async (req, res) => {
  try {
    const [alerts, timeline, vitals, activity] = await Promise.all([
      generateAlerts(),
      getWeeklyTimeline(),
      getVitalsMetrics(),
      getRecentActivity(),
    ]);

    res.json({
      alerts,
      timeline,
      vitals,
      activity,
      lastUpdated: new Date().toISOString(),
    });
  } catch (error) {
    Sentry.captureException(error);
    res.status(500).json({ error: 'Failed to fetch dashboard data' });
  }
});

async function generateAlerts(): Promise<SystemAlert[]> {
  const alerts: SystemAlert[] = [];

  // Failed emails alert
  const { count: failedEmails } = await supabase
    .from('emails')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'failed');

  if (failedEmails && failedEmails > 0) {
    alerts.push({
      id: 'failed-emails',
      severity: failedEmails > 20 ? 'critical' : 'warning',
      title: `${failedEmails} failed emails`,
      message: 'Emails failed to deliver and need retry',
      actionLabel: 'Retry All',
      actionType: 'mutation',
      actionEndpoint: '/api/admin/emails/retry-all',
    });
  }

  // Pick deadline alert
  const { data: nextEpisode } = await supabase
    .from('episodes')
    .select('id, episode_number, pick_deadline')
    .gt('pick_deadline', new Date().toISOString())
    .order('pick_deadline', { ascending: true })
    .limit(1)
    .single();

  if (nextEpisode) {
    const hoursUntil = (new Date(nextEpisode.pick_deadline).getTime() - Date.now()) / (1000 * 60 * 60);
    
    if (hoursUntil <= 24) {
      const { count: submitted } = await supabase
        .from('picks')
        .select('*', { count: 'exact', head: true })
        .eq('episode_id', nextEpisode.id)
        .eq('status', 'submitted');

      const { count: eligible } = await supabase
        .from('league_memberships')
        .select('*', { count: 'exact', head: true });

      const rate = eligible ? (submitted || 0) / eligible : 0;

      alerts.push({
        id: 'pick-deadline',
        severity: rate < 0.5 ? 'warning' : 'info',
        title: `Episode ${nextEpisode.episode_number} locks in ${Math.round(hoursUntil)}h`,
        message: `${submitted}/${eligible} picks submitted (${Math.round(rate * 100)}%)`,
        actionLabel: 'Send Reminder',
        actionType: 'mutation',
        actionEndpoint: `/api/admin/notifications/pick-reminder?episode=${nextEpisode.id}`,
      });
    }
  }

  // Email delivery rate alert
  const { data: emailStats } = await supabase.rpc('get_email_delivery_rate', { days: 7 });
  
  if (emailStats && emailStats.delivery_rate < 0.9) {
    alerts.push({
      id: 'email-delivery',
      severity: emailStats.delivery_rate < 0.7 ? 'critical' : 'warning',
      title: `Email delivery at ${Math.round(emailStats.delivery_rate * 100)}%`,
      message: 'Delivery rate below 90% threshold',
      actionLabel: 'Investigate',
      actionType: 'link',
      actionEndpoint: '/admin/communicate/email',
    });
  }

  return alerts.sort((a, b) => {
    const order = { critical: 0, warning: 1, info: 2 };
    return order[a.severity] - order[b.severity];
  });
}
```

---

## 8-19. [Additional Specifications]

See full blueprint document for:
- Section 8: Leagues Page Specification
- Section 9: Castaways Page Specification
- Section 10: Users Page Specification
- Section 11: Announcements Page Specification
- Section 12: Push Notifications Page Specification
- Section 13: Email Queue Page Specification
- Section 14: SMS Page Specification
- Section 15: Job Monitor Page Specification
- Section 16: System Health Page Specification
- Section 17: Analytics System Specification
- Section 18: Database Schema Additions
- Section 19: Implementation Priority

---

## IMPLEMENTATION PRIORITY

| Priority | Page/Feature | Effort | Impact | Dependencies |
|----------|--------------|--------|--------|--------------|
| 1 | Dashboard with alerts | 8h | High | Alert generation logic |
| 2 | Job Monitor | 4h | High | job_runs table, node-cron logging |
| 3 | Email Queue | 4h | High | Resend webhooks, email_events table |
| 4 | System Health | 3h | Medium | Service health checks |
| 5 | Users page | 6h | Medium | User segmentation logic |
| 6 | Leagues page | 6h | Medium | Revenue calculations |
| 7 | Castaways page | 4h | Medium | Elimination flow |
| 8 | Analytics Executive | 6h | High | Funnel + donation queries |
| 9 | Analytics Engagement | 6h | Medium | Cohort + segment queries |
| 10 | Analytics Operations | 3h | Low | Performance tracking |
| 11 | Push Notifications | 4h | Low | Push service integration |
| 12 | Announcements | 3h | Low | announcements tables |
| 13 | SMS | 3h | Low | Twilio integration |

Total estimated effort: 60 hours

---

## APPENDIX: Key Decisions Log

| Date | Decision | Rationale | Alternatives Rejected |
|------|----------|-----------|----------------------|
| Dec 30, 2024 | Use TanStack Query for all admin data fetching | Provides caching, background refetch, optimistic updates, devtools | Redux (overkill), SWR (less features), raw fetch (no caching) |
| Dec 30, 2024 | Store computed donation fees in database | Ensures consistency, enables efficient aggregation queries | Calculate on read (slower queries), store only gross (error prone) |
| Dec 30, 2024 | Use node-cron instead of Supabase Edge Functions for jobs | Simpler debugging, same server as API, easier local development | Supabase cron (harder to debug), separate worker service (complexity) |
| Dec 30, 2024 | Generate alerts dynamically, not stored | Alerts always reflect current state, no stale data | Stored alerts (require cleanup), event-driven (more complex) |
| Dec 30, 2024 | Three-tab analytics structure | Separates concerns by audience, prevents dashboard overload | Single page (too dense), per-metric pages (too fragmented) |
| Dec 30, 2024 | Donation fee structure: 7% platform + Stripe pass-through | Transparent to users, standard marketplace model | Absorb Stripe fees (reduces margin), higher platform fee (user pushback) |
| Dec 30, 2024 | Use Zod for API validation | Runtime type safety, excellent TypeScript integration, good errors | Joi (verbose), Yup (less TS support), manual validation (error prone) |
| Dec 30, 2024 | Webhook-based email tracking via Resend | Real delivery data, no polling needed, standard approach | Polling Resend API (rate limits), no tracking (flying blind) |

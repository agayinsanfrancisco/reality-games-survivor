generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  player
  commissioner
  admin
}

enum LeagueStatus {
  forming
  drafting
  active
  completed
}

enum DraftStatus {
  pending
  in_progress
  completed
}

enum PickStatus {
  pending
  locked
  auto_picked
}

enum WaiverStatus {
  open
  closed
  processing
}

enum ScoringSessionStatus {
  draft
  finalized
}

enum NotificationType {
  email
  sms
  push
}

enum CastawayStatus {
  active
  eliminated
  winner
}

enum PaymentStatus {
  pending
  completed
  refunded
  failed
}

// ============================================
// MODELS
// ============================================

model User {
  id                String   @id @db.Uuid
  email             String   @unique
  displayName       String   @map("display_name")
  phone             String?
  phoneVerified     Boolean  @default(false) @map("phone_verified")
  avatarUrl         String?  @map("avatar_url")
  role              UserRole @default(player)
  notificationEmail Boolean  @default(true) @map("notification_email")
  notificationSms   Boolean  @default(false) @map("notification_sms")
  notificationPush  Boolean  @default(true) @map("notification_push")
  timezone          String   @default("America/Los_Angeles")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  commissionedLeagues League[]         @relation("Commissioner")
  leagueMemberships   LeagueMember[]
  rosters             Roster[]
  weeklyPicks         WeeklyPick[]
  waiverRankings      WaiverRanking[]
  waiverResults       WaiverResult[]
  notifications       Notification[]
  smsCommands         SmsCommand[]
  payments            Payment[]
  scoringSessions     ScoringSession[] @relation("FinalizedBy")
  episodeScores       EpisodeScore[]   @relation("EnteredBy")

  @@index([email])
  @@index([phone])
  @@map("users")
}

model Season {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  number                Int      @unique
  name                  String
  isActive              Boolean  @default(false) @map("is_active")
  registrationOpensAt   DateTime @map("registration_opens_at")
  draftOrderDeadline    DateTime @map("draft_order_deadline")
  registrationClosesAt  DateTime @map("registration_closes_at")
  premiereAt            DateTime @map("premiere_at")
  draftDeadline         DateTime @map("draft_deadline")
  finaleAt              DateTime? @map("finale_at")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  episodes     Episode[]
  castaways    Castaway[]
  scoringRules ScoringRule[]
  leagues      League[]

  @@map("seasons")
}

model Episode {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seasonId        String    @map("season_id") @db.Uuid
  number          Int
  title           String?
  airDate         DateTime  @map("air_date")
  picksLockAt     DateTime  @map("picks_lock_at")
  resultsPostedAt DateTime? @map("results_posted_at")
  waiverOpensAt   DateTime? @map("waiver_opens_at")
  waiverClosesAt  DateTime? @map("waiver_closes_at")
  isFinale        Boolean   @default(false) @map("is_finale")
  isScored        Boolean   @default(false) @map("is_scored")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  season              Season           @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  eliminatedCastaways Castaway[]       @relation("EliminatedIn")
  weeklyPicks         WeeklyPick[]
  waiverRankings      WaiverRanking[]
  waiverResults       WaiverResult[]
  episodeScores       EpisodeScore[]
  scoringSession      ScoringSession?

  @@unique([seasonId, number])
  @@index([seasonId])
  @@index([airDate])
  @@map("episodes")
}

model Castaway {
  id                   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seasonId             String         @map("season_id") @db.Uuid
  name                 String
  age                  Int?
  hometown             String?
  occupation           String?
  photoUrl             String?        @map("photo_url")
  tribeOriginal        String?        @map("tribe_original")
  status               CastawayStatus @default(active)
  eliminatedEpisodeId  String?        @map("eliminated_episode_id") @db.Uuid
  placement            Int?
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  // Relations
  season            Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  eliminatedEpisode Episode?       @relation("EliminatedIn", fields: [eliminatedEpisodeId], references: [id])
  rosters           Roster[]
  weeklyPicks       WeeklyPick[]
  droppedInWaivers  WaiverResult[] @relation("DroppedCastaway")
  acquiredInWaivers WaiverResult[] @relation("AcquiredCastaway")
  episodeScores     EpisodeScore[]

  @@unique([seasonId, name])
  @@index([seasonId])
  @@index([status])
  @@map("castaways")
}

model ScoringRule {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seasonId    String?  @map("season_id") @db.Uuid
  code        String
  name        String
  description String?
  points      Int
  category    String?
  isNegative  Boolean  @default(false) @map("is_negative")
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  season        Season?        @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  episodeScores EpisodeScore[]

  @@unique([seasonId, code])
  @@map("scoring_rules")
}

model League {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  seasonId         String       @map("season_id") @db.Uuid
  name             String
  code             String       @unique
  passwordHash     String?      @map("password_hash")
  commissionerId   String       @map("commissioner_id") @db.Uuid
  maxPlayers       Int          @default(12) @map("max_players")
  isGlobal         Boolean      @default(false) @map("is_global")
  isPublic         Boolean      @default(false) @map("is_public")
  requireDonation  Boolean      @default(false) @map("require_donation")
  donationAmount   Decimal?     @map("donation_amount") @db.Decimal(10, 2)
  donationNotes    String?      @map("donation_notes")
  payoutMethod     String?      @map("payout_method")
  status           LeagueStatus @default(forming)
  draftStatus      DraftStatus  @default(pending) @map("draft_status")
  draftOrder       Json?        @map("draft_order")
  draftStartedAt   DateTime?    @map("draft_started_at")
  draftCompletedAt DateTime?    @map("draft_completed_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  season         Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  commissioner   User           @relation("Commissioner", fields: [commissionerId], references: [id])
  members        LeagueMember[]
  rosters        Roster[]
  weeklyPicks    WeeklyPick[]
  waiverRankings WaiverRanking[]
  waiverResults  WaiverResult[]
  payments       Payment[]

  @@index([seasonId])
  @@index([code])
  @@index([commissionerId])
  @@map("leagues")
}

model LeagueMember {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leagueId      String   @map("league_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  draftPosition Int?     @map("draft_position")
  totalPoints   Int      @default(0) @map("total_points")
  rank          Int?
  joinedAt      DateTime @default(now()) @map("joined_at")

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId])
  @@index([userId])
  @@index([leagueId])
  @@index([leagueId, rank])
  @@map("league_members")
}

model Roster {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leagueId    String    @map("league_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  castawayId  String    @map("castaway_id") @db.Uuid
  draftRound  Int       @map("draft_round")
  draftPick   Int       @map("draft_pick")
  acquiredVia String    @default("draft") @map("acquired_via")
  acquiredAt  DateTime  @default(now()) @map("acquired_at")
  droppedAt   DateTime? @map("dropped_at")

  // Relations
  league   League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  castaway Castaway @relation(fields: [castawayId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId, castawayId])
  @@index([leagueId, userId])
  @@index([castawayId])
  @@map("rosters")
}

model WeeklyPick {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leagueId     String     @map("league_id") @db.Uuid
  userId       String     @map("user_id") @db.Uuid
  episodeId    String     @map("episode_id") @db.Uuid
  castawayId   String?    @map("castaway_id") @db.Uuid
  status       PickStatus @default(pending)
  pointsEarned Int        @default(0) @map("points_earned")
  pickedAt     DateTime?  @map("picked_at")
  lockedAt     DateTime?  @map("locked_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  league   League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  episode  Episode   @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  castaway Castaway? @relation(fields: [castawayId], references: [id])

  @@unique([leagueId, userId, episodeId])
  @@index([episodeId])
  @@index([userId])
  @@index([leagueId, episodeId])
  @@map("weekly_picks")
}

model WaiverRanking {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leagueId    String   @map("league_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  episodeId   String   @map("episode_id") @db.Uuid
  rankings    Json
  submittedAt DateTime @default(now()) @map("submitted_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  league  League  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId, episodeId])
  @@map("waiver_rankings")
}

model WaiverResult {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leagueId           String   @map("league_id") @db.Uuid
  userId             String   @map("user_id") @db.Uuid
  episodeId          String   @map("episode_id") @db.Uuid
  droppedCastawayId  String?  @map("dropped_castaway_id") @db.Uuid
  acquiredCastawayId String?  @map("acquired_castaway_id") @db.Uuid
  waiverPosition     Int      @map("waiver_position")
  processedAt        DateTime @default(now()) @map("processed_at")

  // Relations
  league           League    @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  episode          Episode   @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  droppedCastaway  Castaway? @relation("DroppedCastaway", fields: [droppedCastawayId], references: [id])
  acquiredCastaway Castaway? @relation("AcquiredCastaway", fields: [acquiredCastawayId], references: [id])

  @@index([leagueId, episodeId])
  @@map("waiver_results")
}

model EpisodeScore {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  episodeId     String   @map("episode_id") @db.Uuid
  castawayId    String   @map("castaway_id") @db.Uuid
  scoringRuleId String   @map("scoring_rule_id") @db.Uuid
  quantity      Int      @default(1)
  points        Int
  notes         String?
  enteredBy     String?  @map("entered_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  episode     Episode     @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  castaway    Castaway    @relation(fields: [castawayId], references: [id], onDelete: Cascade)
  scoringRule ScoringRule @relation(fields: [scoringRuleId], references: [id], onDelete: Cascade)
  enteredByUser User?     @relation("EnteredBy", fields: [enteredBy], references: [id])

  @@unique([episodeId, castawayId, scoringRuleId])
  @@index([episodeId])
  @@index([castawayId])
  @@map("episode_scores")
}

model ScoringSession {
  id          String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  episodeId   String               @unique @map("episode_id") @db.Uuid
  status      ScoringSessionStatus @default(draft)
  startedAt   DateTime             @default(now()) @map("started_at")
  finalizedAt DateTime?            @map("finalized_at")
  finalizedBy String?              @map("finalized_by") @db.Uuid

  // Relations
  episode        Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  finalizedByUser User?  @relation("FinalizedBy", fields: [finalizedBy], references: [id])

  @@map("scoring_sessions")
}

model Notification {
  id       String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String           @map("user_id") @db.Uuid
  type     NotificationType
  subject  String?
  body     String
  sentAt   DateTime         @default(now()) @map("sent_at")
  readAt   DateTime?        @map("read_at")
  metadata Json?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, readAt])
  @@map("notifications")
}

model SmsCommand {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone        String
  userId       String?  @map("user_id") @db.Uuid
  command      String
  rawMessage   String   @map("raw_message")
  parsedData   Json?    @map("parsed_data")
  responseSent String?  @map("response_sent")
  processedAt  DateTime @default(now()) @map("processed_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([phone])
  @@index([userId])
  @@map("sms_commands")
}

model Payment {
  id                    String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String        @map("user_id") @db.Uuid
  leagueId              String        @map("league_id") @db.Uuid
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("usd")
  stripeSessionId       String?       @unique @map("stripe_session_id")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  stripeRefundId        String?       @map("stripe_refund_id")
  status                PaymentStatus @default(completed)
  createdAt             DateTime      @default(now()) @map("created_at")
  refundedAt            DateTime?     @map("refunded_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  league League @relation(fields: [leagueId], references: [id])

  @@index([userId])
  @@index([leagueId])
  @@index([stripeSessionId])
  @@map("payments")
}
